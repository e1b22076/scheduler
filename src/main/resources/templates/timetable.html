<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>時間割</title>
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/timetable.css">
</head>

<body>
  <!-- フラッシュメッセージ -->
  <div th:if="${message}" class="flash-message" id="flashMessage">
    <p th:text="${message}"></p>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const message = document.getElementById("flashMessage");

      if (message && message.innerText.trim() !== "") {
        // メッセージを表示
        message.style.display = "block";

        // 5秒後にメッセージを非表示にする
        setTimeout(function () {
          message.style.display = "none";
        }, 4000);  // 4秒後に消える
      }
    });
  </script>

  <!-- メニューバー -->
  <div class="navbar">
    <a href="/calendar" class="link">カレンダー</a>
    <a href="/todolist" class="link">やることリスト</a>
    <form id="logoutForm" th:action="@{/logout}" method="post" style="display: inline;">
      <input type="hidden" id="logoutCsrf" name="${_csrf.parameterName}" value="${_csrf.token}" />
      <button type="submit" class="link">ログアウト</button>
    </form>
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeSettingsModal()">&times;</span>
      <h2>土曜日表示設定</h2>
      <form id="settingsForm" th:action="@{/saveSettings}" method="post">
        <input type="hidden" id="settingsCsrf" name="${_csrf.parameterName}" value="${_csrf.token}" />
        <input type="hidden" id="toggleSaturdayHidden" name="toggleSaturday" th:value="${showSaturday ? 1 : -1}">
        <label for="toggleSaturdayModal">
          <input type="checkbox" id="toggleSaturdayModal" name="toggleSaturday" th:checked="${showSaturday}" value="1">
          土曜日を表示する
        </label><br>
        <button type="submit" class="submit-button">変更を保存</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const checkbox = document.getElementById('toggleSaturdayModal');
      const hiddenInput = document.getElementById('toggleSaturdayHidden');

      // 初期状態でhiddenの値を設定
      hiddenInput.value = checkbox.checked ? '1' : '-1';

      // チェックボックスの状態変更時にhiddenの値を上書き
      checkbox.addEventListener('change', function () {
        hiddenInput.value = checkbox.checked ? '1' : '-1';
      });
    });
  </script>

  <script>
    // 設定モーダルを表示
    function toggleSettingsModal() {
      document.getElementById("settingsModal").style.display = "flex";
    }

    // 設定モーダルを閉じる
    function closeSettingsModal() {
      document.getElementById("settingsModal").style.display = "none";
    }

    // 変更を保存
    function submitChanges() {
      const form = document.getElementById("settingsForm");
      form.submit();
    }
  </script>

  <div class="title-container" th:attr="data-show-saturday=${showSaturday}">
    <h1>時間割</h1>

    <div class="table-container">
      <button id="settingsButton" class="settings-button" onclick="toggleSettingsModal()">土曜日設定</button>

      <table id="scheduleTable">
        <tr>
          <th>＼</th>
          <th>月</th>
          <th>火</th>
          <th>水</th>
          <th>木</th>
          <th>金</th>
          <th class="saturday-column">土</th>
        </tr>

        <!--1限目-->
        <tr>
          <th>1限目</th>
          <td td class="schedule-cell" th:text="${timeTableRecord.monday[0]}" data-day="月" data-period="1限目" th:attr="data-classname=${timeTableRecord.monday[0]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.tuesday[0]}" data-day="火" data-period="1限目" th:attr="data-classname=${timeTableRecord.tuesday[0]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.wednesday[0]}" data-day="水" data-period="1限目" th:attr="data-classname=${timeTableRecord.wednesday[0]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.thursday[0]}" data-day="木" data-period="1限目" th:attr="data-classname=${timeTableRecord.thursday[0]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.friday[0]}" data-day="金" data-period="1限目" th:attr="data-classname=${timeTableRecord.friday[0]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.saturday[0]}" data-day="土" data-period="1限目" th:attr="data-classname=${timeTableRecord.saturday[0]}"></td>
        </tr>

        <!--2限目-->
        <tr>
          <th>2限目</th>
          <td td class="schedule-cell" th:text="${timeTableRecord.monday[1]}" data-day="月" data-period="2限目" th:attr="data-classname=${timeTableRecord.monday[1]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.tuesday[1]}" data-day="火" data-period="2限目" th:attr="data-classname=${timeTableRecord.tuesday[1]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.wednesday[1]}" data-day="水" data-period="2限目" th:attr="data-classname=${timeTableRecord.wednesday[1]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.thursday[1]}" data-day="木" data-period="2限目" th:attr="data-classname=${timeTableRecord.thursday[1]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.friday[1]}" data-day="金" data-period="2限目" th:attr="data-classname=${timeTableRecord.friday[1]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.saturday[1]}" data-day="土" data-period="1限目" th:attr="data-classname=${timeTableRecord.saturday[1]}"></td>
        </tr>

        <!--3限目-->
        <tr>
          <th>3限目</th>
          <td td class="schedule-cell" th:text="${timeTableRecord.monday[2]}" data-day="月" data-period="3限目" th:attr="data-classname=${timeTableRecord.monday[2]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.tuesday[2]}" data-day="火" data-period="3限目" th:attr="data-classname=${timeTableRecord.tuesday[2]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.wednesday[2]}" data-day="水" data-period="3限目" th:attr="data-classname=${timeTableRecord.wednesday[2]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.thursday[2]}" data-day="木" data-period="3限目" th:attr="data-classname=${timeTableRecord.thursday[2]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.friday[2]}" data-day="金" data-period="3限目" th:attr="data-classname=${timeTableRecord.friday[2]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.saturday[2]}" data-day="土" data-period="3限目" th:attr="data-classname=${timeTableRecord.saturday[2]}"></td>
        </tr>

        <!-- 4限目 -->
        <tr>
          <th>4限目</th>
          <td td class="schedule-cell" th:text="${timeTableRecord.monday[3]}" data-day="月" data-period="4限目" th:attr="data-classname=${timeTableRecord.monday[3]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.tuesday[3]}" data-day="火" data-period="4限目" th:attr="data-classname=${timeTableRecord.tuesday[3]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.wednesday[3]}" data-day="水" data-period="4限目" th:attr="data-classname=${timeTableRecord.wednesday[3]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.thursday[3]}" data-day="木" data-period="4限目" th:attr="data-classname=${timeTableRecord.thursday[3]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.friday[3]}" data-day="金" data-period="4限目" th:attr="data-classname=${timeTableRecord.friday[3]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.saturday[3]}" data-day="土" data-period="4限目" th:attr="data-classname=${timeTableRecord.saturday[3]}"></td>
        </tr>

        <!-- 5限目 -->
        <tr>
          <th>5限目</th>
          <td td class="schedule-cell" th:text="${timeTableRecord.monday[4]}" data-day="月" data-period="5限目" th:attr="data-classname=${timeTableRecord.monday[4]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.tuesday[4]}" data-day="火" data-period="5限目" th:attr="data-classname=${timeTableRecord.tuesday[4]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.wednesday[4]}" data-day="水" data-period="5限目" th:attr="data-classname=${timeTableRecord.wednesday[4]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.thursday[4]}" data-day="木" data-period="5限目" th:attr="data-classname=${timeTableRecord.thursday[4]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.friday[4]}" data-day="金" data-period="5限目" th:attr="data-classname=${timeTableRecord.friday[4]}"></td>
          <td td class="schedule-cell" th:text="${timeTableRecord.saturday[4]}" data-day="土" data-period="5限目" th:attr="data-classname=${timeTableRecord.saturday[4]}"></td>
        </tr>
      </table>
    </div>
  </div>

  <script>
    // 土曜日列全体を非表示にする
    document.addEventListener("DOMContentLoaded", function () {
      const titleContainer = document.querySelector(".title-container");
      const showSaturday = titleContainer.getAttribute("data-show-saturday") === "true";

      const saturdayColumns = document.querySelectorAll(".saturday-column");
      const table = document.getElementById("scheduleTable");

      if (!showSaturday) {
        saturdayColumns.forEach(column => {
          column.style.display = "none";
        });
        const rows = table.querySelectorAll("tr");
        rows.forEach(row => {
          const saturdayCell = row.querySelector("td:last-child, th:last-child");
          if (saturdayCell) {
            saturdayCell.style.display = "none";
          }
        });
      } else {
        saturdayColumns.forEach(column => {
          column.style.display = "table-cell";
        });
        const rows = table.querySelectorAll("tr");
        rows.forEach(row => {
          const saturdayCell = row.querySelector("td:last-child, th:last-child");
          if (saturdayCell) {
            saturdayCell.style.display = "table-cell";
          }
        });
      }
    });
  </script>

  <script>
    // 設定メニューを切り替える
    function toggleSettingsMenu() {
      const settingsMenu = document.getElementById("settingsMenu");
      settingsMenu.style.display = settingsMenu.style.display === "block" ? "none" : "block";
    }

    // 今日の曜日を取得
    const today = new Date().getDay();
    const todayColumnIndex = (today === 0) ? 6 : today - 1;
    const table = document.getElementById("scheduleTable");

    // 強調クラスを追加
    const columnCells = table.querySelectorAll(`td:nth-child(${todayColumnIndex + 2})`); // ヘッダーは除外するため +2
    columnCells.forEach(cell => {
      // 奇数行・偶数行に応じて色を付ける
      if (cell.parentElement.rowIndex % 2 === 0) {
        cell.classList.add("highlight-even"); // 偶数行
      } else {
        cell.classList.add("highlight-odd"); // 奇数行
      }
    });
  </script>

  <!-- 授業を登録するモーダル -->
  <div id="addClassModal" class="modal" data-day="" data-period="">
    <div class="modal-content">
      <span class="close" onclick="closeModal('addClassModal')">&times;</span>
      <p id="addClassModal-title">空きコマ</p>
      <div class="flex-container">
        <p>このコマに授業を登録しますか？</p>
        <button class="submit-button" onclick="redirectToAddClass()">授業を登録</button>
      </div>
    </div>
  </div>

  <!-- 授業情報を表示するモーダル -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <div class="menu-wrapper">
        <span class="menu-icon" onclick="toggleMenu()">&#x22EE;</span>
        <div id="menu-dropdown" class="menu-dropdown">
          <div onclick="changeClassColor()">授業カラー</div>
          <div onclick="openModal('removeModal', this)">授業をコマから外す</div>
        </div>
      </div>
      <span class="close" onclick="closeModal('infoModal')">&times;</span>
      <p id="infoModal-title">曜日、時限、授業名</p>
      <p id="modal-classname"></p>
      <div>
        <p><strong>課題:</strong></p>
        <p id="modal-assignment">-</p>
      </div>
      <div>
        <p><strong>テスト日程:</strong></p>
        <p id="modal-test-schedule">-</p>
      </div>
    </div>
  </div>

  <!-- 授業を外すモーダル -->
  <div id="removeModal" class="modal">
    <div class="modal-content">
      <p class="removeModal-title" id="removeClassInfo"></p>
      <p>本当にこの授業をコマから外しますか？</p>
      <form th:action="@{/removeClass}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="hidden" id="removeDay" name="day" value="">
        <input type="hidden" id="removePeriod" name="period" value="">
        <input type="hidden" id="removeValue" name="removeValue" value="">
        <button class="submit-button" type="button" onclick="closeModal('removeModal')">キャンセル</button>
        <button class="remove-button" type="submit">授業を外す</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // 授業セルと空きコマセルのクリック処理を一括登録
      document.querySelectorAll(".schedule-cell").forEach(cell => {
        cell.addEventListener("click", () => {
          const className = cell.textContent.trim(); // セルの内容を取得
          const day = cell.getAttribute("data-day");
          const period = cell.getAttribute("data-period");

          // 空きコマの場合
          if (!className) {
            openModal("addClassModal", cell);
          } else {
            openModal("infoModal", cell);
          }
        });
      });
    });

    // モーダルを開く関数
    function openModal(modalId, tdElement) {
      const modal = document.getElementById(modalId);

      if (tdElement) {
        const removeButton = tdElement; const day = tdElement.getAttribute('data-day');
        const period = tdElement.getAttribute('data-period');
        const className = removeButton.getAttribute('data-classname');

        // 空きコマの場合
        if (modalId === "addClassModal") {
          // 'addClassModal'用のデータ設定
          document.getElementById("addClassModal-title").innerText = `${day} ${period}: 空きコマ`;
          modal.setAttribute('data-day', day); // モーダルにデータ属性として保持
          modal.setAttribute('data-period', period); // モーダルにデータ属性として保持
        }

        // 'infoModal'を開くとき
        if (modalId === "infoModal") {
          document.getElementById("infoModal-title").innerText = `${day} ${period}: ${className}`;
          document.getElementById("modal-assignment").innerText = "特定の課題がありません";
          document.getElementById("modal-test-schedule").innerText = "テスト日程は未定です";

          // メニューの「授業をコマから外す」に授業情報を設定
          const removeButton = document.querySelector('.menu-dropdown div:nth-child(2)');
          removeButton.setAttribute('data-day', day);
          removeButton.setAttribute('data-period', period);
          removeButton.setAttribute('data-className', className);
        }

        // 'removeModal'を開くとき
        else if (modalId === "removeModal") {
          const removeButton = tdElement;
          document.getElementById("removeDay").value = removeButton.getAttribute('data-day');
          document.getElementById("removePeriod").value = removeButton.getAttribute('data-period');
          document.getElementById("removeValue").value = removeButton.getAttribute('data-className');

          document.getElementById("removeDay").value = day;
          document.getElementById("removePeriod").value = period;
          document.getElementById("removeValue").value = className;

          // 授業情報を表示
          document.getElementById("removeClassInfo").innerText = `${day} ${period}: ${className}`;
        }
      }

      modal.style.display = "flex"; // モーダルを表示
    }

    // 授業を登録するページに遷移
    function redirectToAddClass() {
      const modal = document.getElementById("addClassModal");
      const day = modal.getAttribute('data-day'); // モーダルに設定されたデータを取得
      const period = modal.getAttribute('data-period');

      // URLクエリパラメータにデータを追加
      window.location.href = `/timetable/addClass?day=${encodeURIComponent(day)}&period=${encodeURIComponent(period)}`;
    }

    // メニュー内の「授業をコマから外す」クリック時
    document.querySelector('.menu-dropdown div:nth-child(2)').addEventListener('click', function () {
      openModal('removeModal', this);
    });

    // モーダルを閉じる関数
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = "none";
    }

    // メニュー表示/非表示の切り替え
    function toggleMenu() {
      const menuDropdown = document.getElementById("menu-dropdown");
      menuDropdown.style.display = menuDropdown.style.display === "block" ? "none" : "block";
    }

    // 授業名のセルクリック時の処理
    document.querySelectorAll('.class-cell').forEach(cell => {
      cell.addEventListener('click', function () {
        openModal('infoModal', this);
      });
    });

    window.onclick = function (event) {
      const menuDropdown = document.getElementById("menu-dropdown");
      if (!event.target.matches('.menu-icon')) {
        menuDropdown.style.display = "none";
      }
    };
  </script>
</body>

</html>
